{% extends "base.html" %}

{% block title %}–î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π{% endblock %}

{% block content %}
<h2 class="text-center mb-4">–î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h2>

<!-- –§–æ—Ä–º–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Ç–µ–º–µ -->
<form method="get" class="mb-4 text-center">
  <label for="topic-select" class="form-label me-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
  <select name="topic" id="topic-select" class="form-select d-inline-block w-auto">
    <option value="" {% if not request.GET.topic %}selected{% endif %}>–í—Å–µ —Ç–µ–º—ã</option>
    <option value="sale_rent" {% if request.GET.topic == "sale_rent" %}selected{% endif %}>–ü—Ä–æ–¥–∞–∂–∞/–∞—Ä–µ–Ω–¥–∞ —É—á–∞—Å—Ç–∫–æ–≤</option>
    <option value="services" {% if request.GET.topic == "services" %}selected{% endif %}>–£—Å–ª—É–≥–∏</option>
    <option value="equipment" {% if request.GET.topic == "equipment" %}selected{% endif %}>–¢–µ—Ö–Ω–∏–∫–∞</option>
    <option value="materials" {% if request.GET.topic == "materials" %}selected{% endif %}>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
    <option value="garden" {% if request.GET.topic == "garden" %}selected{% endif %}>–°–∞–¥ –∏ –æ–≥–æ—Ä–æ–¥</option>
    <option value="other" {% if request.GET.topic == "other" %}selected{% endif %}>–î—Ä—É–≥–æ–µ</option>
  </select>
  <button type="submit" class="btn btn-primary ms-2">–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
</form>

{% if page_obj %}
  <div class="ads-container d-flex flex-wrap justify-content-start gap-3">
    {% for ad in page_obj %}
      <div class="ad-card">
        <h5 class="ad-title mb-2">{{ ad.title }}</h5>
        <p class="text-muted mb-2" style="font-size: 0.9rem; font-style: italic;">
           {{ ad.community.name }}
        </p>

        <div class="ad-description description-truncate-5 mb-3" id="desc-{{ forloop.counter }}">
          {{ ad.description|linebreaksbr }}
        </div>
        <button class="btn read-more-btn" data-target="desc-{{ forloop.counter }}" style="display:none;">
          –ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
        </button>

        {% if ad.photo %}
          <img src="{{ ad.photo.url }}" alt="{{ ad.title }}" class="ad-photo" data-full="{{ ad.photo.url }}">
        {% endif %}

        <div class="ad-info mt-auto w-100 d-flex justify-content-between align-items-center">
          <div class="contact-info">
            <i class="fas fa-phone-alt"></i> {{ ad.contact }}
          </div>
          <div class="post-meta text-end">
            <small>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ ad.created_at|date:"d.m.Y H:i" }}</small><br>
            <small>–ê–≤—Ç–æ—Ä: {{ ad.owner.get_full_name|default:ad.owner.username }}</small>
          </div>
        </div>

        {% if user.is_authenticated and ad.owner == user %}
          <div class="ad-actions mt-3 text-center">
            <a href="{% url 'edit_advertisement' ad.pk %}" class="btn btn-sm btn-outline-primary me-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="{% url 'delete_advertisement' ad.pk %}" class="btn btn-sm btn-outline-danger">–£–¥–∞–ª–∏—Ç—å</a>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if request.GET.topic %}topic={{ request.GET.topic }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo;</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">&laquo;</span>
        </li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
          {% if num == page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?{% if request.GET.topic %}topic={{ request.GET.topic }}&{% endif %}page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if request.GET.topic %}topic={{ request.GET.topic }}&{% endif %}page={{ page_obj.next_page_number }}">&raquo;</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">&raquo;</span>
        </li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <p class="text-center">–û–±—ä—è–≤–ª–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
<div id="modal-photo" class="modal-photo" style="display:none;">
  <span class="modal-close">&times;</span>
  <img class="modal-content" id="modal-img" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
</div>

<style>
  .ads-container {
    gap: 2rem;
  }

  .ad-card {
    background-color: #f9fff9;
    border: 1px solid #c3e6cb;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    min-height: 280px;
    box-sizing: border-box;

    flex: 0 0 19%;
    max-width: 19%;
    align-items: center;
  }

  .ad-card:hover {
    box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    transform: translateY(-5px);
  }

  .ad-title {
    font-weight: 700;
    color: #2f855a;
    font-size: 1.2rem;
    text-align: center;
    margin-bottom: 0.5rem;
    position: relative;
  }

  .ad-title::before {
    content: "üì¢";
    position: absolute;
    left: -25px;
    top: 0;
    font-size: 1.1rem;
  }

  .ad-description {
    font-size: 0.95rem;
    line-height: 1.3em;
    color: #333;
  }

  .description-truncate-5 {
    max-height: 6.5em; /* –æ–∫–æ–ª–æ 5 —Å—Ç—Ä–æ–∫ * 1.3em */
    overflow: hidden;
    transition: max-height 0.3s ease;
    white-space: normal;
  }

  .read-more-btn {
    background: none;
    border: none;
    color: #2f855a;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 10px;
  }

  .ad-photo {
    max-width: 150px;
    height: auto;
    object-fit: contain;
    cursor: pointer;
    border-radius: 8px;
    border: 1px solid #c3e6cb;
    margin: 1rem auto;
    transition: transform 0.3s ease;
  }

  .ad-photo:hover {
    transform: scale(1.05);
  }

  .ad-info {
    font-size: 0.85rem;
    color: #555;
    border-top: 1px solid #c3e6cb;
    padding-top: 0.5rem;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .contact-info i {
    color: #2f855a;
    margin-right: 6px;
  }

  .ad-actions {
    text-align: center;
  }

  .ad-actions a {
    text-decoration: none;
  }

  .ad-actions a:hover {
    text-decoration: underline;
  }

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
  .modal-photo {
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal-photo .modal-content {
    max-width: 90%;
    max-height: 90%;
    border-radius: 4px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  .modal-photo .modal-close {
    position: absolute;
    top: 20px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    transition: color 1.5s ease;
  }
  .modal-photo .modal-close:hover {
    color: #bbb;
  }

  /* Media Queries –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
  @media (max-width: 1199.98px) {
    .ad-card {
      flex: 0 0 23%;
      max-width: 23%;
    }
  }

  @media (max-width: 991.98px) {
    .ad-card {
      flex: 0 0 31%;
      max-width: 31%;
    }
  }

  @media (max-width: 767.98px) {
    .ad-card {
      flex: 0 0 48%;
      max-width: 48%;
    }
  }

  @media (max-width: 575.98px) {
    .ad-card {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.read-more-btn');
    buttons.forEach(btn => {
      const targetId = btn.getAttribute('data-target');
      const desc = document.getElementById(targetId);
      if (!desc) return;

      const lineHeight = parseFloat(getComputedStyle(desc).lineHeight);
      const collapsedHeight = 6.5 * lineHeight; // —Å–º 6.5em –≤ px
      if (desc.scrollHeight > collapsedHeight + 1) {
        btn.style.display = 'inline';
        desc.style.maxHeight = collapsedHeight + 'px';

        btn.addEventListener('click', () => {
          if (desc.style.maxHeight !== desc.scrollHeight + 'px') {
            desc.style.maxHeight = desc.scrollHeight + 'px';
            btn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
          } else {
            desc.style.maxHeight = collapsedHeight + 'px';
            btn.textContent = '–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
          }
        });
      } else {
        btn.style.display = 'none';
      }
    });

    // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    const modal = document.getElementById('modal-photo');
    const modalImg = document.getElementById('modal-img');
    const modalClose = modal.querySelector('.modal-close');
    document.querySelectorAll('.ad-photo').forEach(img => {
      img.addEventListener('click', () => {
        modal.style.display = 'flex';
        modalImg.src = img.dataset.full || img.src;
        modalImg.alt = img.alt || '–§–æ—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è';
      });
    });
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
</script>

{% endblock %}
