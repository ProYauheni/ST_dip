{% extends 'base.html' %}

{% block content %}

<div class="text-center my-0">
  <h2>–°–∞–¥–æ–≤–æ–¥—á–µ—Å–∫–æ–µ —Ç–æ–≤–∞—Ä–∏—â–µ—Å—Ç–≤–æ ¬´{{ community.name }}¬ª</h2>
  {% if community.description %}
  <p class="community-description" id="community-description"
     style="overflow: hidden; max-height: 3em; line-height: 1.4em; transition: max-height 0.3s ease;">
    {{ community.description }}
  </p>

  <button id="toggle-description-btn" class="btn btn-link p-0 mt-1" style="display:none;">
    –ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
  </button>
  {% endif %}
</div>

<hr>

<div class="d-flex justify-content-center gap-3 flex-wrap">

    <a href="{% url 'profile' %}" class="btn btn-outline-primary square-btn">
        –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢
    </a>

    <a href="{% url 'community_contacts' %}" class="btn btn-outline-primary square-btn">
        –ö–û–ù–¢–ê–ö–¢–´
    </a>

    <a href="{% url 'voting_list' %}" class="btn btn-outline-primary square-btn">
        –ì–û–õ–û–°–û–í–ê–ù–ò–Ø
    </a>

    <a href="{% url 'community_payment' %}" class="btn btn-outline-primary square-btn">
        –í–ó–ù–û–°–´
    </a>

    <a href="{% url 'documents_list' community.id %}" class="btn btn-outline-primary square-btn">
        –î–û–ö–£–ú–ï–ù–¢–´
    </a>

</div>

<hr>

<h3 class="text-center mb-4" style="color: #2f855a; font-weight: 700; font-size: 1.7rem;">–ù–æ–≤–æ—Å—Ç–∏ –∏ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>

{% if is_chairman_or_board %}
  <div class="text-center mb-5">
    <a href="{% url 'add_news' community.id %}" class="btn btn-success btn-lg px-4" style="font-weight: 400;">
      –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å
    </a>
  </div>
{% endif %}

{% if news %}
<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for item in news %}
    <div class="col">
        <div class="card h-100 shadow-sm border-0"
     style="{% if item.pinned %}background-color: #fff3cd;{% else %}background: linear-gradient(135deg, #d1e7dd 0%, #b7dbca 100%);{% endif %} border-radius: 12px;">
            <div class="card-body d-flex flex-column">
               <h5 class="card-title text-center" style="font-weight: 700; color: #276749; min-height: 3rem;">
                  {% if item.pinned %}
                    <span title="–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ" style="color: #ca3e47; margin-right: 5px;">üìå</span>
                  {% endif %}
                  {{ item.title }}
                </h5>

                <p class="card-text" id="news-content-{{ forloop.counter }}"
                   style="overflow: hidden; max-height: 4.5em; line-height: 1.3em; transition: max-height 0.3s ease; color: #1a202c;">
                    {{ item.content }}
                </p>
                <button class="btn btn-link p-0 mt-2 align-self-start text-success read-more-btn"
                        data-target="news-content-{{ forloop.counter }}" style="display:none; font-weight: 600;">
                    –ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
                </button>

                <small class="news-date text-success mt-auto" id="news-date-{{ forloop.counter }}" style="font-size: 0.85rem;">
                    {{ item.created_at|date:"d.m.Y H:i" }}
                </small>

                {% if is_chairman_or_board %}
                <div class="mt-3 align-self-start d-flex gap-2 flex-wrap">
                    <form method="post" action="{% url 'toggle_pin_news' item.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-info btn-sm" style="font-weight: 600;">
                          {% if item.pinned %}–û—Ç–∫—Ä–µ–ø–∏—Ç—å{% else %}–ó–∞–∫—Ä–µ–ø–∏—Ç—å{% endif %}
                        </button>
                    </form>

                    <a href="{% url 'edit_news' item.pk %}" class="btn btn-outline-warning btn-sm" style="font-weight: 600;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

                    <form method="post" action="{% url 'delete_news' item.pk %}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm" style="font-weight: 600;">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{# –ü–∞–≥–∏–Ω–∞—Ü–∏—è #}
{% if news.has_other_pages %}
<nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π" class="mt-4">
  <ul class="pagination justify-content-center">
    {% if news.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ news.previous_page_number }}" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
          <span aria-hidden="true">&laquo;</span>
          <span class="visually-hidden">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-hidden="true">&laquo;</span>
      </li>
    {% endif %}

    {% for num in news.paginator.page_range %}
      {% if news.number == num %}
        <li class="page-item active" aria-current="page">
          <span class="page-link">{{ num }}</span>
        </li>
      {% elif num > news.number|add:'-5' and num < news.number|add:'5' %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if news.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ news.next_page_number }}" aria-label="–°–ª–µ–¥—É—é—â–∞—è">
          <span aria-hidden="true">&raquo;</span>
          <span class="visually-hidden">–°–ª–µ–¥—É—é—â–∞—è</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-hidden="true">&raquo;</span>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% else %}
<p class="text-center" style="font-style: italic; color: #718096;">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π.</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é"
    const description = document.getElementById('community-description');
    const descBtn = document.getElementById('toggle-description-btn');
    if (description && descBtn) {
        if (description.scrollHeight > description.clientHeight + 1) {
            descBtn.style.display = 'inline-block';
        }
        descBtn.addEventListener('click', function () {
            if (description.style.maxHeight && description.style.maxHeight !== '3em') {
                description.style.maxHeight = '3em';
                descBtn.textContent = '–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
            } else {
                description.style.maxHeight = description.scrollHeight + 'px';
                descBtn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
            }
        });
    }

    // –ö–Ω–æ–ø–∫–∏ "–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é" –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π
    const buttons = document.querySelectorAll('.read-more-btn');

    buttons.forEach(function(button) {
        const targetId = button.getAttribute('data-target');
        const content = document.getElementById(targetId);

        if (!content) return;

        if (content.scrollHeight > content.clientHeight + 1) {
            button.style.display = 'inline-block';
        }

        button.addEventListener('click', function() {
            if (content.style.maxHeight && content.style.maxHeight !== '4.5em') {
                content.style.maxHeight = '4.5em';
                this.textContent = '–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                this.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
            }
        });
    });
});
</script>
{% endblock %}
