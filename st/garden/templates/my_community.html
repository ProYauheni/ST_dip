{% extends 'base.html' %}

{% block content %}

<div class="text-center my-0">
  <h2>Садоводческое товарищество «{{ community.name }}»</h2>
  {% if community.description %}
  <p class="community-description" id="community-description"
     style="overflow: hidden; max-height: 3em; line-height: 1.4em; transition: max-height 0.3s ease;">
    {{ community.description }}
  </p>

  <button id="toggle-description-btn" class="btn btn-link p-0 mt-1" style="display:none;">
    Читать полностью
  </button>
{% endif %}
</div>

<hr>

<div class="d-flex justify-content-center gap-3 flex-wrap">

    <a href="{% url 'profile' %}" class="btn btn-outline-primary square-btn">
        ЛИЧНЫЙ КАБИНЕТ
    </a>

    <a href="{% url 'community_contacts' %}" class="btn btn-outline-primary square-btn">
        КОНТАКТЫ
    </a>

    <a href="{% url 'voting_list' %}" class="btn btn-outline-primary square-btn">
        ГОЛОСОВАНИЯ
    </a>

    <a href="{% url 'community_payment' %}" class="btn btn-outline-primary square-btn">
        ВЗНОСЫ
    </a>

    <a href="{% url 'documents_list' community.id %}" class="btn btn-outline-primary square-btn">
        ДОКУМЕНТЫ
    </a>

</div>

<hr>

<h3 class="text-center mb-4" style="color: #2f855a; font-weight: 700; font-size: 1.7rem;">Новости и важные сообщения</h3>

{% if is_chairman_or_board %}
  <div class="text-center mb-5">
    <a href="{% url 'add_news' community.id %}" class="btn btn-success btn-lg px-4" style="font-weight: 400;">
      Добавить новость
    </a>
  </div>
{% endif %}

{% if news %}
<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for item in news %}
    <div class="col">
        <div class="card h-100 shadow-sm border-0" style="background: linear-gradient(135deg, #d1e7dd 0%, #b7dbca 100%); border-radius: 12px;">
            <div class="card-body d-flex flex-column">
               <h5 class="card-title text-center" style="font-weight: 700; color: #276749; min-height: 3rem;">
                  {{ item.title }}
                </h5>


                <p class="card-text" id="news-content-{{ forloop.counter }}"
                   style="overflow: hidden; max-height: 4.5em; line-height: 1.3em; transition: max-height 0.3s ease; color: #1a202c;">
                    {{ item.content }}
                </p>
                <button class="btn btn-link p-0 mt-2 align-self-start text-success read-more-btn"
                        data-target="news-content-{{ forloop.counter }}" style="display:none; font-weight: 600;">
                    Читать полностью
                </button>

                <small class="news-date text-success mt-auto" id="news-date-{{ forloop.counter }}" style="font-size: 0.85rem;">
                    {{ item.created_at|date:"d.m.Y H:i" }}
                </small>

                {% if is_chairman_or_board %}
                <div class="mt-3 align-self-start d-flex gap-2">
                    <a href="{% url 'edit_news' item.pk %}" class="btn btn-outline-warning btn-sm" style="font-weight: 600;">Редактировать</a>

                    <form method="post" action="{% url 'delete_news' item.pk %}" onsubmit="return confirm('Удалить новость?');" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm" style="font-weight: 600;">Удалить</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{# Пагинация #}
{% if news.has_other_pages %}
<nav aria-label="Пагинация новостей" class="mt-4">
  <ul class="pagination justify-content-center">
    {% if news.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ news.previous_page_number }}" aria-label="Предыдущая">
          <span aria-hidden="true">&laquo;</span>
          <span class="visually-hidden">Предыдущая</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-hidden="true">&laquo;</span>
      </li>
    {% endif %}

    {% for num in news.paginator.page_range %}
      {% if news.number == num %}
        <li class="page-item active" aria-current="page">
          <span class="page-link">{{ num }}</span>
        </li>
      {% elif num > news.number|add:'-5' and num < news.number|add:'5' %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if news.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ news.next_page_number }}" aria-label="Следующая">
          <span aria-hidden="true">&raquo;</span>
          <span class="visually-hidden">Следующая</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-hidden="true">&raquo;</span>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% else %}
<p class="text-center" style="font-style: italic; color: #718096;">Пока нет новостей.</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Описание сообщества с кнопкой "Читать полностью"
    const description = document.getElementById('community-description');
    const descBtn = document.getElementById('toggle-description-btn');
    if (description && descBtn) {
        if (description.scrollHeight > description.clientHeight + 1) {
            descBtn.style.display = 'inline-block';
        }
        descBtn.addEventListener('click', function () {
            if (description.style.maxHeight && description.style.maxHeight !== '3em') {
                description.style.maxHeight = '3em';
                descBtn.textContent = 'Читать полностью';
            } else {
                description.style.maxHeight = description.scrollHeight + 'px';
                descBtn.textContent = 'Свернуть';
            }
        });
    }

    // Кнопки "Читать полностью" для новостей
    const buttons = document.querySelectorAll('.read-more-btn');

    buttons.forEach(function(button) {
        const targetId = button.getAttribute('data-target');
        const content = document.getElementById(targetId);

        if (!content) return;

        if (content.scrollHeight > content.clientHeight + 1) {
            button.style.display = 'inline-block';
        }

        button.addEventListener('click', function() {
            if (content.style.maxHeight && content.style.maxHeight !== '4.5em') {
                content.style.maxHeight = '4.5em';
                this.textContent = 'Читать полностью';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                this.textContent = 'Свернуть';
            }
        });
    });
});
</script>
{% endblock %}